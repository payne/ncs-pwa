<div class="container-fluid">
  <div class="header-row">
    <h1>
      Main View
      <span class="current-net-label" *ngIf="currentNetName">NET:</span>
      <span class="current-net-name" *ngIf="currentNetName">{{ currentNetName }}</span>
      <span class="read-only-badge" *ngIf="currentNetId && !canEdit">(Read Only)</span>
    </h1>
  </div>

  <div *ngIf="!currentNetId" class="no-net-message">
    <mat-icon>info</mat-icon>
    <span>Please select a NET from the menu to view entries.</span>
  </div>

  <div *ngIf="currentNetId" class="main-view-content">
    <!-- Header Section -->
    <div class="header-section">
      <div class="header-toggle" (click)="toggleHeader()">
        <mat-icon>{{ headerCollapsed ? 'expand_more' : 'expand_less' }}</mat-icon>
        <span>Net Details</span>
        <span class="header-summary" *ngIf="headerCollapsed && header.netOpened">
          | {{ header.type || 'No type' }} | Started: {{ header.netOpened }}
          <span *ngIf="header.netStopped"> | Stopped: {{ header.netStopped }}</span>
        </span>
      </div>

      <div class="header-content" *ngIf="!headerCollapsed">
        <div class="header-controls-row">
          <div class="header-field">
            <label>Net Control Op:</label>
            <input type="text"
                   class="header-input"
                   [(ngModel)]="header.netControlOp"
                   (blur)="onHeaderFieldBlur()"
                   [disabled]="!canEdit"
                   placeholder="Enter operator name">
          </div>

          <div class="header-field">
            <label>Type:</label>
            <select class="header-select"
                    [(ngModel)]="header.type"
                    (change)="onHeaderFieldBlur()"
                    [disabled]="!canEdit">
              <option value="">Select type...</option>
              <option *ngFor="let type of netTypes" [value]="type">{{ type }}</option>
            </select>
          </div>

          <div class="header-field">
            <label>Reason for Net:</label>
            <input type="text"
                   class="header-input"
                   [(ngModel)]="header.reasonForNet"
                   (blur)="onHeaderFieldBlur()"
                   [disabled]="!canEdit"
                   placeholder="Enter reason">
          </div>
        </div>

        <div class="header-timing-row">
          <div class="header-field">
            <label>Net Opened:</label>
            <div class="timing-group">
              <input type="text"
                     class="header-input timing-input"
                     [(ngModel)]="header.netOpened"
                     (blur)="onHeaderFieldBlur()"
                     [disabled]="!canEdit"
                     placeholder="Not started">
              <button mat-raised-button
                      [color]="isNetRunning() ? 'warn' : 'primary'"
                      (click)="toggleNetStatus()"
                      [disabled]="!canEdit || (header.netOpened && header.netStopped)"
                      class="start-stop-btn">
                <mat-icon>{{ isNetRunning() ? 'stop' : 'play_arrow' }}</mat-icon>
                {{ isNetRunning() ? 'Stop' : 'Start' }}
              </button>
            </div>
          </div>

          <div class="header-field">
            <label>Net Stopped:</label>
            <input type="text"
                   class="header-input timing-input"
                   [(ngModel)]="header.netStopped"
                   (blur)="onHeaderFieldBlur()"
                   [disabled]="!canEdit"
                   placeholder="Not stopped">
          </div>

          <div class="header-field">
            <label>Net Duration:</label>
            <span class="duration-value">{{ getNetDuration() || '--' }}</span>
          </div>
        </div>

        <div class="header-comments">
          <label>Comments:</label>
          <textarea class="comments-textarea"
                    [(ngModel)]="header.comments"
                    (blur)="onHeaderFieldBlur()"
                    [disabled]="!canEdit"
                    rows="3"
                    placeholder="Enter comments..."></textarea>
        </div>
      </div>
    </div>

    <!-- Autocomplete Dropdown -->
    <div class="autocomplete-dropdown" *ngIf="showAutocomplete && canEdit">
      <div class="autocomplete-header">Select a person:</div>
      <div class="autocomplete-results">
        <div *ngFor="let person of filteredPeople; let i = index"
             class="autocomplete-item"
             [class.selected]="i === selectedAutocompleteIndex"
             (click)="selectPerson(person)">
          {{ person.call || person.callsign }} - {{ person.firstName || person.first }} {{ person.lastName || person.last }}
        </div>
      </div>
    </div>

    <!-- Entries Table -->
    <div class="table-container">
      <table mat-table [dataSource]="dataSource" matSort class="mat-elevation-z2">

        <!-- Call Column -->
        <ng-container matColumnDef="call">
          <th mat-header-cell *matHeaderCellDef mat-sort-header>Call</th>
          <td mat-cell *matCellDef="let entry">
            <ng-container *ngIf="entry.isNew && canEdit">
              <input class="add-row-input"
                     [(ngModel)]="addEntryPlaceholder.call"
                     (input)="onCallsignInput(addEntryPlaceholder.call)"
                     (keydown)="onCallsignKeydown($event)"
                     (blur)="hideAutocomplete()"
                     placeholder="Enter callsign">
            </ng-container>
            <ng-container *ngIf="!entry.isNew">
              <input class="cell-input"
                     [value]="entry.call"
                     (blur)="onCellBlur(entry, 'call', $any($event.target).value)"
                     [disabled]="!canEdit">
            </ng-container>
          </td>
        </ng-container>

        <!-- First Column -->
        <ng-container matColumnDef="first">
          <th mat-header-cell *matHeaderCellDef mat-sort-header>First</th>
          <td mat-cell *matCellDef="let entry">
            <ng-container *ngIf="entry.isNew && canEdit">
              <input class="add-row-input"
                     [(ngModel)]="addEntryPlaceholder.first"
                     placeholder="First name">
            </ng-container>
            <ng-container *ngIf="!entry.isNew">
              <input class="cell-input"
                     [value]="entry.first"
                     (blur)="onCellBlur(entry, 'first', $any($event.target).value)"
                     [disabled]="!canEdit">
            </ng-container>
          </td>
        </ng-container>

        <!-- Last Initial Column -->
        <ng-container matColumnDef="lastInitial">
          <th mat-header-cell *matHeaderCellDef mat-sort-header>Last</th>
          <td mat-cell *matCellDef="let entry">
            <ng-container *ngIf="entry.isNew && canEdit">
              <input class="add-row-input last-initial-input"
                     [(ngModel)]="addEntryPlaceholder.lastInitial"
                     maxlength="1"
                     placeholder="L">
            </ng-container>
            <ng-container *ngIf="!entry.isNew">
              <input class="cell-input last-initial-input"
                     [value]="entry.lastInitial"
                     (blur)="onCellBlur(entry, 'lastInitial', $any($event.target).value)"
                     maxlength="1"
                     [disabled]="!canEdit">
            </ng-container>
          </td>
        </ng-container>

        <!-- Assignment 1 Column -->
        <ng-container matColumnDef="assignment1">
          <th mat-header-cell *matHeaderCellDef mat-sort-header>Assignment</th>
          <td mat-cell *matCellDef="let entry">
            <ng-container *ngIf="entry.isNew && canEdit">
              <input class="add-row-input"
                     [(ngModel)]="addEntryPlaceholder.assignment1"
                     placeholder="Assignment">
            </ng-container>
            <ng-container *ngIf="!entry.isNew">
              <input class="cell-input"
                     [value]="entry.assignment1"
                     (blur)="onCellBlur(entry, 'assignment1', $any($event.target).value)"
                     [disabled]="!canEdit">
            </ng-container>
          </td>
        </ng-container>

        <!-- Status 1 Column -->
        <ng-container matColumnDef="status1">
          <th mat-header-cell *matHeaderCellDef class="status-header">S1</th>
          <td mat-cell *matCellDef="let entry" class="status-cell" [ngClass]="getStatusClass(entry.status1)">
            <ng-container *ngIf="entry.isNew && canEdit">
              <input class="status-input"
                     [(ngModel)]="addEntryPlaceholder.status1"
                     maxlength="1"
                     placeholder="">
            </ng-container>
            <ng-container *ngIf="!entry.isNew">
              <input class="status-input"
                     [value]="entry.status1"
                     (blur)="onCellBlur(entry, 'status1', $any($event.target).value)"
                     maxlength="1"
                     [disabled]="!canEdit">
            </ng-container>
          </td>
        </ng-container>

        <!-- Status 2 Column -->
        <ng-container matColumnDef="status2">
          <th mat-header-cell *matHeaderCellDef class="status-header">S2</th>
          <td mat-cell *matCellDef="let entry" class="status-cell" [ngClass]="getStatusClass(entry.status2)">
            <ng-container *ngIf="entry.isNew && canEdit">
              <input class="status-input"
                     [(ngModel)]="addEntryPlaceholder.status2"
                     maxlength="1"
                     placeholder="">
            </ng-container>
            <ng-container *ngIf="!entry.isNew">
              <input class="status-input"
                     [value]="entry.status2"
                     (blur)="onCellBlur(entry, 'status2', $any($event.target).value)"
                     maxlength="1"
                     [disabled]="!canEdit">
            </ng-container>
          </td>
        </ng-container>

        <!-- Status 3 Column -->
        <ng-container matColumnDef="status3">
          <th mat-header-cell *matHeaderCellDef class="status-header">S3</th>
          <td mat-cell *matCellDef="let entry" class="status-cell" [ngClass]="getStatusClass(entry.status3)">
            <ng-container *ngIf="entry.isNew && canEdit">
              <input class="status-input"
                     [(ngModel)]="addEntryPlaceholder.status3"
                     maxlength="1"
                     placeholder="">
            </ng-container>
            <ng-container *ngIf="!entry.isNew">
              <input class="status-input"
                     [value]="entry.status3"
                     (blur)="onCellBlur(entry, 'status3', $any($event.target).value)"
                     maxlength="1"
                     [disabled]="!canEdit">
            </ng-container>
          </td>
        </ng-container>

        <!-- Status 4 Column -->
        <ng-container matColumnDef="status4">
          <th mat-header-cell *matHeaderCellDef class="status-header">S4</th>
          <td mat-cell *matCellDef="let entry" class="status-cell" [ngClass]="getStatusClass(entry.status4)">
            <ng-container *ngIf="entry.isNew && canEdit">
              <input class="status-input"
                     [(ngModel)]="addEntryPlaceholder.status4"
                     maxlength="1"
                     placeholder="">
            </ng-container>
            <ng-container *ngIf="!entry.isNew">
              <input class="status-input"
                     [value]="entry.status4"
                     (blur)="onCellBlur(entry, 'status4', $any($event.target).value)"
                     maxlength="1"
                     [disabled]="!canEdit">
            </ng-container>
          </td>
        </ng-container>

        <!-- Assignment 2 Column -->
        <ng-container matColumnDef="assignment2">
          <th mat-header-cell *matHeaderCellDef mat-sort-header>Assignment 2</th>
          <td mat-cell *matCellDef="let entry">
            <ng-container *ngIf="entry.isNew && canEdit">
              <input class="add-row-input"
                     [(ngModel)]="addEntryPlaceholder.assignment2"
                     placeholder="Assignment 2">
            </ng-container>
            <ng-container *ngIf="!entry.isNew">
              <input class="cell-input"
                     [value]="entry.assignment2"
                     (blur)="onCellBlur(entry, 'assignment2', $any($event.target).value)"
                     [disabled]="!canEdit">
            </ng-container>
          </td>
        </ng-container>

        <!-- Status 5 Column -->
        <ng-container matColumnDef="status5">
          <th mat-header-cell *matHeaderCellDef class="status-header">S5</th>
          <td mat-cell *matCellDef="let entry" class="status-cell" [ngClass]="getStatusClass(entry.status5)">
            <ng-container *ngIf="entry.isNew && canEdit">
              <input class="status-input"
                     [(ngModel)]="addEntryPlaceholder.status5"
                     maxlength="1"
                     placeholder="">
            </ng-container>
            <ng-container *ngIf="!entry.isNew">
              <input class="status-input"
                     [value]="entry.status5"
                     (blur)="onCellBlur(entry, 'status5', $any($event.target).value)"
                     maxlength="1"
                     [disabled]="!canEdit">
            </ng-container>
          </td>
        </ng-container>

        <!-- Status 6 Column -->
        <ng-container matColumnDef="status6">
          <th mat-header-cell *matHeaderCellDef class="status-header">S6</th>
          <td mat-cell *matCellDef="let entry" class="status-cell" [ngClass]="getStatusClass(entry.status6)">
            <ng-container *ngIf="entry.isNew && canEdit">
              <input class="status-input"
                     [(ngModel)]="addEntryPlaceholder.status6"
                     maxlength="1"
                     placeholder="">
            </ng-container>
            <ng-container *ngIf="!entry.isNew">
              <input class="status-input"
                     [value]="entry.status6"
                     (blur)="onCellBlur(entry, 'status6', $any($event.target).value)"
                     maxlength="1"
                     [disabled]="!canEdit">
            </ng-container>
          </td>
        </ng-container>

        <!-- Status 7 Column -->
        <ng-container matColumnDef="status7">
          <th mat-header-cell *matHeaderCellDef class="status-header">S7</th>
          <td mat-cell *matCellDef="let entry" class="status-cell" [ngClass]="getStatusClass(entry.status7)">
            <ng-container *ngIf="entry.isNew && canEdit">
              <input class="status-input"
                     [(ngModel)]="addEntryPlaceholder.status7"
                     maxlength="1"
                     placeholder="">
            </ng-container>
            <ng-container *ngIf="!entry.isNew">
              <input class="status-input"
                     [value]="entry.status7"
                     (blur)="onCellBlur(entry, 'status7', $any($event.target).value)"
                     maxlength="1"
                     [disabled]="!canEdit">
            </ng-container>
          </td>
        </ng-container>

        <!-- Status 8 Column -->
        <ng-container matColumnDef="status8">
          <th mat-header-cell *matHeaderCellDef class="status-header">S8</th>
          <td mat-cell *matCellDef="let entry" class="status-cell" [ngClass]="getStatusClass(entry.status8)">
            <ng-container *ngIf="entry.isNew && canEdit">
              <input class="status-input"
                     [(ngModel)]="addEntryPlaceholder.status8"
                     maxlength="1"
                     placeholder="">
            </ng-container>
            <ng-container *ngIf="!entry.isNew">
              <input class="status-input"
                     [value]="entry.status8"
                     (blur)="onCellBlur(entry, 'status8', $any($event.target).value)"
                     maxlength="1"
                     [disabled]="!canEdit">
            </ng-container>
          </td>
        </ng-container>

        <!-- Notes Column -->
        <ng-container matColumnDef="notes">
          <th mat-header-cell *matHeaderCellDef mat-sort-header>Notes</th>
          <td mat-cell *matCellDef="let entry">
            <ng-container *ngIf="entry.isNew && canEdit">
              <input class="add-row-input notes-input"
                     [(ngModel)]="addEntryPlaceholder.notes"
                     placeholder="Notes">
            </ng-container>
            <ng-container *ngIf="!entry.isNew">
              <input class="cell-input notes-input"
                     [value]="entry.notes"
                     (blur)="onCellBlur(entry, 'notes', $any($event.target).value)"
                     [disabled]="!canEdit">
            </ng-container>
          </td>
        </ng-container>

        <!-- Actions Column -->
        <ng-container matColumnDef="actions">
          <th mat-header-cell *matHeaderCellDef class="actions-header"></th>
          <td mat-cell *matCellDef="let entry" class="actions-cell">
            <ng-container *ngIf="entry.isNew && canEdit">
              <button mat-icon-button color="primary" (click)="addEntry()" matTooltip="Add Entry">
                <mat-icon>add</mat-icon>
              </button>
            </ng-container>
            <ng-container *ngIf="!entry.isNew && canEdit">
              <button mat-icon-button [matMenuTriggerFor]="actionMenu" class="action-menu-btn">
                <mat-icon>more_vert</mat-icon>
              </button>
              <mat-menu #actionMenu="matMenu">
                <button mat-menu-item (click)="deleteEntry(entry)" class="delete-action">
                  <mat-icon color="warn">delete</mat-icon>
                  <span>Delete</span>
                </button>
              </mat-menu>
            </ng-container>
          </td>
        </ng-container>

        <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
        <tr mat-row *matRowDef="let row; columns: displayedColumns;"
            [class.add-row]="row.isNew"></tr>
      </table>
    </div>

    <!-- Status Legend -->
    <div class="status-legend">
      <span class="legend-title">Status Legend:</span>
      <span class="legend-item status-present">P = Present</span>
      <span class="legend-item status-absent">A = Absent</span>
      <span class="legend-item status-late">L = Late</span>
      <span class="legend-item status-excused">E = Excused</span>
      <span class="legend-item status-checked-out">X = Checked Out</span>
    </div>
  </div>
</div>
